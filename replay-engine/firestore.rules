
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null &&
        request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Replay jobs are the master record for a render request.
    match /replayJobs/{jobId} {
      // Users can create and read their own jobs.
      // Admins can do anything.
      // Updates are backend-only (admin).
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Replay renders are the output of a job.
    match /replayRenders/{renderId} {
      // Users can read renders linked to their jobs.
      allow read: if isAdmin() || isOwner(get(/databases/$(database)/documents/replayJobs/$(resource.data.replayId)).data.userId);

      // Renders are created and updated by the backend only.
      allow create, update: if isAdmin();
      allow delete: if false; // Render records are immutable.
    }
  }
}

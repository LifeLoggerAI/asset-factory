
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Global Helper Functions ---

    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isRequestingUser(userId) {
      return request.auth.uid == userId;
    }

    function isNewDoc() {
      return resource == null;
    }

    function isExistingDoc() {
      return resource != null;
    }

    // --- Tenants Collection ---
    // Controls access to user-specific subscription and billing data.
    match /tenants/{tenantId} {
      // Users can read their own tenant document.
      // Admins (in the future) could also have read access.
      allow read: if isUserAuthenticated() && isRequestingUser(tenantId);

      // No client-side writes are allowed to prevent tampering with billing status.
      allow write: if false;
    }

    // --- Jobs Collection ---
    // The core of the asset factory, representing work to be done.
    match /jobs/{jobId} {
      // Users can read jobs they own.
      allow read: if isUserAuthenticated() && isRequestingUser(resource.data.ownerId);

      // Allow users to create jobs if they are the owner and the data is valid.
      allow create: if isUserAuthenticated() 
                      && isRequestingUser(request.resource.data.ownerId)
                      && request.resource.data.status == 'pending';

      // Jobs are immutable from the client-side once created.
      // Only the backend can update job status.
      allow update, delete: if false;
    }

    // --- Usage Ledger Collection ---
    // Tracks billable events. Critical for revenue integrity.
    match /usage_ledger/{usageId} {
      // Users can read their own usage records to see their history.
      allow read: if isUserAuthenticated() && isRequestingUser(resource.data.ownerId);

      // Only the backend can write to the usage ledger to prevent fraud.
      allow write: if false;
    }

    // --- Dead Jobs Collection ---
    // Jobs that have failed permanently.
    match /dead_jobs/{jobId} {
      // Users can see jobs that have failed to allow for support requests.
      allow read: if isUserAuthenticated() && isRequestingUser(resource.data.ownerId);
      
      // No client-side writes.
      allow write: if false;
    }

    // --- System Metrics Collection ---
    // Aggregated operational data. Should not be client-accessible.
    match /system_metrics/{metricId} {
      allow read, write: if false;
    }

    // --- Billing Audit Collection ---
    // Reconciliation logs. Should not be client-accessible.
    match /billing_audit/{auditId} {
        allow read, write: if false;
    }
  }
}
